@model GenxAi_Solutions.Models.LoginViewModel

@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Login</title>
    <link href="~/css/styles.css" rel="stylesheet" />
    <link href="~/css/styles_custom.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- ✅ Add jQuery -->
    <script src="~/js/jwtjs.js"></script>

</head>
<body class="bg-white">
    <div class="container-fluid h-100">
        <div class="row no-gutter h-100">
            <!-- The content half -->
            <div class="col-md-6 bg-light">
                <div class="login d-flex align-items-center h-100">
                    <div class="container">
                        <div class="row">
                            <div class="text-center pb-4">
                                <img class="login-logo" src="~/assets/img/GenXAILatest.png" />
                            </div>
                            <div class="col-lg-10 col-xl-7 mx-auto">
                                <!-- ✅ Remove asp-action -->
                                <form id="loginForm">
                                    <div class="form-floating mb-3 floating-custom-label">
                                        <input asp-for="Email" id="Email" class="form-control" placeholder="name@example.com" />
                                        <label>Email address</label>
                                    </div>
                                    <div class="form-floating mb-3 floating-custom-label">
                                        <input asp-for="Password" id="Password" type="password" class="form-control" placeholder="Password" />
                                        <label>Password</label>
                                    </div>
                                    <div class="text-danger" id="errorMsg"></div>
                                    <div class="d-flex justify-content-between align-items-center my-3">
                                        <div>
                                            <button type="submit" class="btn btn-success btn-block text-uppercase mb-2 rounded shadow-sm">Sign in</button>
                                        </div>

                                        <div id="btnLoader" class="spinner-border text-success ms-2" role="status"
                                             style="width:1.5rem; height:1.5rem; display:none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div>
                                            @* <a class="text-decoration-none" href="javascript:void(0);">Forgot password?</a> *@
                                            <a class="text-decoration-none" href="/User/ForgotPassword">Forgot password?</a>

                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- The image half -->
            <div class="col-md-6 d-none d-md-flex bg-image"></div>
        </div>
    </div>
    <footer class="bg-dark login-footer text-white mt-auto py-2">
        <p class="m-0">Developed and Maintained By<a href="javascript:void(0);" class="px-2 d-inline-block text-white font-bold">GenXAI Analytics Pvt Ltd</a></p>
    </footer>

  


    <!-- ✅ AJAX Script -->
    <script>
        $("#loginForm").submit(function (e) {
            e.preventDefault(); // stop normal form submit

            var data = {
                Email: $("#Email").val(),
                Password: $("#Password").val()
            };


            $.ajax({
                url: "/api/auth/login",  // ✅ Your API endpoint
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                    beforeSend: function () {
            $("#btnLoader").show(); // ✅ Show loader
        },
                success: function (res) {
                    
                    if(res.status)
                    {
                        debugger;
                    $("#btnLoader").hide();
                   // ✅ Store groupId in local variable
                    var groupId = res.groupId;
                         // Store in localStorage
                     localStorage.setItem("groupId", groupId);
                     //localStorage.setItem("accessToken", res.accessToken);
                     saveTokens(res);
                    // Show message
                    debugger;
                    $("#errorMsg").removeClass("text-danger").addClass("text-success").text(res.message);
                    if(res.groupId=='1')
                    {
                        // ✅ Redirect to Home page
                    window.location.href = "/CompanyOnboard/Chatbot";
                    }
                    else{
                        // ✅ Redirect to Home page
                   // window.location.href = "/UserMaster/Add";
                     window.location.href = "/UserMaster/Add?tab=Userlist";
                    }

                    }
                    
                },
                error: function (err) {
                    $("#btnLoader").hide();
                    var msg = "Login failed.";
                    debugger;
                    if (err.responseJSON && err.responseJSON.message) {
                        msg = err.responseJSON.message;
                    }
                    $("#errorMsg").removeClass("text-success").addClass("text-danger").text(msg);
                }
            });
        });


    </script>

  @*   <script>
        $("#loginForm").submit(function (e) {
            e.preventDefault(); // stop normal form submit

            var data = {
                Email: $("#Email").val(),
                Password: $("#Password").val()
            };

            $.ajax({
                url: "/api/auth/login",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                beforeSend: function () {
                    $("#btnLoader").show(); // Show loader
                },
                success: function (res) {

                    if (res.status) {
                        $("#btnLoader").hide();

                        var groupId = res.groupId;

                        // Save values
                        localStorage.setItem("groupId", groupId);
                        saveTokens(res);

                        $("#errorMsg")
                            .removeClass("text-danger")
                            .addClass("text-success")
                            .text(res.message);

                        if (res.groupId == '1') {
                            window.location.href = "/CompanyOnboard/Chatbot";
                        } else {
                            window.location.href = "/UserMaster/Add?tab=Userlist";
                        }
                    }
                },
                error: function (xhr) {
                    $("#btnLoader").hide();

                    // ⭐⭐⭐ TOKEN EXPIRED HANDLING (STEP 2 LOGIC)
                    if (xhr.status === 440 ||
                        (xhr.responseJSON && xhr.responseJSON.message === "Token expired"))
                    {
                        $("#errorMsg")
                            .removeClass("text-success")
                            .addClass("text-danger")
                            .text("Your session has expired. Please login again.");

                        // Clear saved tokens
                        localStorage.clear();

                        // Redirect to Login Page after 1.5 sec
                        setTimeout(function () {
                            window.location.href = "/api/auth/login";
                        }, 1500);

                        return;
                    }

                    // Normal login error handling
                    var msg = "Login failed.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }

                    $("#errorMsg")
                        .removeClass("text-success")
                        .addClass("text-danger")
                        .text(msg);
                }
            });
        });
    </script> *@

   

</body>
</html>

@model UserMaster
@{
    ViewData["Title"] = "User Master";
}
@* <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
<link href="~/css/styles.css" rel="stylesheet" />
<link href="~/css/styles_custom.css" rel="stylesheet" />
<link href="css/table-card.css" rel="stylesheet" />
<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script src="~/js/scripts.js"></script>
<script src="~/js/custom.js"></script> *@
<script src="~/js/user-validation.js"></script> 

<style>
    .btn-loading {
        position: relative;
        color: transparent !important;
    }

        .btn-loading:after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .is-invalid {
        border-color: red !important;
    }
</style>


<div class="container-fluid p-4">
    <div class="row">
        <div class="col-md-12 p-0 border">
            <div class="bg-white shadow custom-tabs">
                <ul class="nav bg-light nav-pills border-bottom" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab1-tab" data-bs-toggle="pill" @* data-bs-toggle="tab" *@
                                data-bs-target="#tab1" type="button" role="tab"
                                aria-controls="tab1" aria-selected="true">
                            Add User
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab2-tab" @* data-bs-toggle="pill" *@ data-bs-toggle="tab"
                                data-bs-target="#tab2" type="button" role="tab"
                                aria-controls="tab2" aria-selected="false">
                            User List
                        </button>
                    </li>

                </ul>

                <div class="tab-content m2 p-3 border bg-white" id="myTabContent">
                    <div class="tab-pane fade show active" id="tab1" role="tabpanel"
                         aria-labelledby="tab1-tab">
                        <div class="card bg-light border rounded-0 shadoww">
                            <div class="card-body bg-white text-dark roundedd p-3">
                                <div class="border-bottom pb-2 mb-3 d-flex align-items-center">
                                    @* <div> <img height="50" src="~/assets/img/user.png" /></div> *@

                                    <div class="px-3">
                                        <h5>
                                            User Master
                                        </h5>
                                    </div>
                                </div>

                                <form id="usergrpForm">
                                    <input type="hidden" id="Id" value="0" />

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>First Name</label>
                                                <input id="FirstName" class="form-control" type="text" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Middle Name</label>
                                                <input id="MiddleName" class="form-control" type="text" />
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Last Name</label>
                                                <input id="LastName" class="form-control" type="text" />
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Email</label>
                                                <input id="Email" class="form-control" type="text" />
                                                <span id="emailError" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Address1</label>
                                                <input id="Address1" class="form-control" type="text" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Address2</label>
                                                <input id="Address2" class="form-control" type="text" />
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Address3</label>
                                                <input id="Address3" class="form-control" type="text" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Pincode</label>
                                                <input id="Pincode" class="form-control" type="text" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Profile Photo</label>
                                                @*  <input id="Profilephoto" class="form-control" type="text" /> *@
                                                <span id="ProfilePath"></span>
                                                <input type="file" class="form-control" id="ProfilePhoto" name="ProfilePhoto">
                                                @*  <label>Select file</label> *@
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>GroupId</label>
                                                <select asp-for="GroupId" asp-items="Model.Group" class="form-control" id="grpid">
                                                    <option value="">--Select--</option>
                                                </select>
                                                @* <input id="Groupid" class="form-control" type="text" /> *@
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>CompanyId</label>
                                                <select asp-for="CompanyId" asp-items="Model.Company" class="form-control" id="companyid">
                                                    <option value="">--Select--</option>
                                                </select>
                                                @* <input id="Companyid" class="form-control" type="email" /> *@
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>MobileNo</label>
                                                <input id="Mobileno" class="form-control" type="number" />
                                                <span id="mobileError" class="text-danger"></span>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>LoginID</label>
                                                <input id="LoginID" class="form-control" type="text" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Password</label>
                                                <input id="Password" class="form-control" type="password" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Save/Update button -->
                                    <div class="text-end">
                                        <button type="button" id="btnSave" class="btn btn-outline-success btn-block rounded shadow-sm">
                                            <i class="fa fa-save"></i> <span>Save</span>
                                        </button>
                                        <button type="button" id="btnUpdate" class="btn btn-outline-primary btn-block rounded shadow-sm" style="display:none;">
                                            <i class="bi bi-pencil-square me-1"></i> <span>Update</span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab2" role="tabpanel"
                         aria-labelledby="tab2-tab">
                        <div class="card border rounded-0">
                            <div class="card-body p-0 border-0 rounded-0">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="wrap">
                                            <div class="table-wrapper">
                                                <table class="table table-bordered table-striped">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Id</th>
                                                            <th>First Name</th>
                                                            <th>Middle Name</th>
                                                            <th>Last Name</th>
                                                            <th>Email</th>
                                                            <th>Address1</th>
                                                            <th>Address2</th>
                                                            <th>Address3</th>
                                                            <th>Pincode</th>
                                                            <th>ProfilePhoto</th>
                                                            <th>MobileNo</th>
                                                            <th>LoginId</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="UserList">
                                                        <tr>
                                                            <td colspan="13">Loading...</td>
                                                        </tr>
                                                        <tr>

                                                            <td>
                                                                <button class="btn-edit border-0 bg-transparent me-1">
                                                                    <i class="bi bi-pencil-square text-success fs-5"></i>
                                                                </button>
                                                                <button class="btn-delete border-0 bg-transparent">
                                                                    <i class="bi bi-trash-fill text-danger fs-5"></i>
                                                                </button>
                                                            </td>
                                                        </tr>

                                                    </tbody>
                                                </table>
                                                <!-- Pagination -->
                                                <nav aria-label="Page navigation">
                                                    <ul class="pagination justify-content-center" id="pagination">
                                                        <!-- Pagination will be dynamically generated here -->
                                                    </ul>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

<script>

    $(document).ready(function () {

         // Global variables for pagination
        let currentPage = 1;
        const recordsPerPage = 10;
        let totalRecords = 0;
        let allUsers = [];

        // Show Toast
        function showMessage(message, type) {
            var bgClass = "bg-" + type;
            var toastHtml = `
                <div class="toast align-items-center text-white ${bgClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>`;
            var $toast = $(toastHtml);
            $(".toast-container").append($toast);
            var toast = new bootstrap.Toast($toast[0], { autohide: true, delay: 3000 });
            toast.show();
            $toast.on('hidden.bs.toast', function () { $(this).remove(); });
        }
        // Show Loader
        function showLoader() {
            if ($('#loaderOverlay').length === 0) {
                $('body').append(`
                    <div class="loader-overlay" id="loaderOverlay">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            }
        }

        // Hide Loader
        function hideLoader() {
            $('#loaderOverlay').remove();
        }

        // Show Button Loader
        function showButtonLoader($btn, text) {
            $btn.prop('disabled', true);
            $btn.addClass('btn-loading');
            $btn.find('span').text(text);
        }

        // Hide Button Loader
        function hideButtonLoader($btn, originalText) {
            $btn.prop('disabled', false);
            $btn.removeClass('btn-loading');
            $btn.find('span').text(originalText);
        }


        // Reset form
        function resetForm() {
            $("#Id").val(0);
            $("#FirstName").val("");
            $("#MiddleName").val("");
            $("#LastName").val("");
            $("#Mobileno").val("");
            $("#Email").val("");
            $("#Password").val("");
            $("#Address1").val("");
            $("#Address2").val("");
            $("#Address3").val("");
            $("#Pincode").val("");
            $("#ProfilePhoto").val(null);
            $("#grpid").val("");
            $("#companyid").val("");
            $("#LoginID").val("");
            $("#btnSave").show();
            $("#btnUpdate").hide();
        }

        // ✅ Load all users

            let isUsersLoading = false;
            let usersLoaded = false;
        function loadUsers() {
            // Prevent multiple simultaneous calls
    if (isUsersLoading) {
        //console.log('Users are already loading, skipping duplicate call');
        return;
    }

    isUsersLoading = true;
            $("#UserList").html('<tr><td colspan="13">Loading...</td></tr>');
            $.ajax({
                url: "/api/auth/GetAllUserMaster",
                type: "GET",
                success: function (data) {
                    isUsersLoading = false;
                    usersLoaded = true;
                    if (!data || data.length === 0) {
                        $("#UserList").html('<tr><td colspan="13">No users found</td></tr>');
                        return;
                    }
                     allUsers = data;
                    totalRecords = data.length;
                    setupPagination();
                    displayUsersForCurrentPage(1);

                    var html = "";
                    data.forEach(function (u) {
                        html += `<tr>
                                    <td>${u.id}</td>
                                    <td>${u.firstName}</td>
                                    <td>${u.middleName}</td>
                                    <td>${u.lastName}</td>
                                    <td>${u.email}</td>
                                    <td>${u.address1}</td>
                                    <td>${u.address2}</td>
                                    <td>${u.address3}</td>
                                    <td>${u.pincode}</td>
                                    <td>${u.profilePhoto}</td>
                                    <td>${u.mobileNo}</td>
                                    <td>${u.loginID}</td>
                                    <td>
                                        <input type="hidden" class="hiddenUser" value="${u.id}" />
                                        <button class="btn-edit border-0 bg-transparent me-1">
                                            <i class="bi bi-pencil-square text-success fs-5"></i>
                                        </button>
                                        <button class="btn-delete border-0 bg-transparent">
                                            <i class="bi bi-trash-fill text-danger fs-5"></i>
                                        </button>
                                    </td>
                                </tr>`;
                    });

                    $("#UserList").html(html);
                },
                error: function () {
                    isUsersLoading = false;
                    $("#UserList").html('<tr><td colspan="13">Error loading users</td></tr>');
                }
            });
        }

            // Auto-switch to User List tab if URL parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'Userlist') {
        // Use setTimeout to ensure DOM is fully ready
        setTimeout(() => {
            var tab2Trigger = document.querySelector('#tab2-tab');
            if (tab2Trigger) {
                var tab = new bootstrap.Tab(tab2Trigger);
                tab.show();

               if (!usersLoaded && !isUsersLoading) {
                loadUsers();
            }
            }
        }, 100);
    }

    // Also enhance the tab click event to update URL
    $('#tab2-tab').on('shown.bs.tab', function () {
        // Update URL without page reload
        const newUrl = window.location.pathname + '?tab=Userlist';
        window.history.replaceState({}, '', newUrl);
        loadUsers();
    });

    $('#tab1-tab').on('shown.bs.tab', function () {
        // Clear the tab parameter when switching to Add User tab
        window.history.replaceState({}, '', window.location.pathname);
    });

    // End Auto-switch to User List tab if URL parameter is present

        function setupPagination() {
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const pagination = $("#pagination");
            pagination.empty();

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `);

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `);

            // Page info
            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
            // pagination.after(`
            //     <div class="text-center mt-2 text-muted small">
            //         Showing ${startRecord} to ${endRecord} of ${totalRecords} entries
            //     </div>
            // `);
        }

        function changePage(page) {
            if (page < 1 || page > Math.ceil(totalRecords / recordsPerPage)) return;
            currentPage = page;
            displayUsersForCurrentPage(currentPage);
            setupPagination();
        }

        // Display users for current page
        function displayUsersForCurrentPage() {
             if (allUsers.length === 0) {
            $("#UserList").html('<tr><td colspan="13">No users found</td></tr>');
            $('#paginationInfo').text(`Showing 0 to 0 of 0 entries`);
             return;
    }

            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const usersToDisplay = allUsers.slice(startIndex, endIndex);

            if (usersToDisplay.length === 0) {
                $("#UserList").html('<tr><td colspan="13">No users found</td></tr>');
                return;
            }

            let html = "";
            usersToDisplay.forEach(function (u) {
                html += `<tr>
                            <td>${u.id}</td>
                            <td>${u.firstName}</td>
                            <td>${u.middleName}</td>
                            <td>${u.lastName}</td>
                            <td>${u.email}</td>
                            <td>${u.address1}</td>
                            <td>${u.address2}</td>
                            <td>${u.address3}</td>
                            <td>${u.pincode}</td>
                            <td>${u.profilePhoto}</td>
                            <td>${u.mobileNo}</td>
                            <td>${u.loginID}</td>
                            <td>
                                <input type="hidden" class="hiddenUser" value="${u.id}" />
                                <button class="btn-edit border-0 bg-transparent me-1">
                                    <i class="bi bi-pencil-square text-success fs-5"></i>
                                </button>
                                <button class="btn-delete border-0 bg-transparent">
                                    <i class="bi bi-trash-fill text-danger fs-5"></i>
                                </button>
                            </td>
                        </tr>`;
            });

            $("#UserList").html(html);
            //setupPagination();
        }



        // Save User
        $("#btnSave").on("click", function (e) {
            e.preventDefault();
            // ✅ Call shared validation before AJAX
             if (!validateEmailAndMobile()) return;
             const $btn = $(this);
            const originalText = $btn.find('span').text();
            //const $btn = $(this);
            const ddlgroup=document.getElementById('grpid');
            const groupval = ddlgroup.value;
             //const txt = ddlgroup.options[ddlgroup.selectedIndex]?.text ?? '';
             const ddlcompany=document.getElementById('companyid');
            const companyval = ddlcompany.value;
            //const txtcom = ddlcompany.options[ddlcompany.selectedIndex]?.text ?? '';


            // var data = {
            //     FirstName: $("#FirstName").val(),
            //     MiddleName: $("#MiddleName").val(),
            //     LastName: $("#LastName").val(),
            //     MobileNo: $("#Mobileno").val(),
            //     Email: $("#Email").val(),
            //     Password: $("#Password").val(),
            //     Address1: $("#Address1").val(),
            //     Address2: $("#Address2").val(),
            //     Address3: $("#Address3").val(),
            //     Pincode: $("#Pincode").val(),
            //    // ProfilePhoto: $("#Profilephoto").val(),
            //     GroupId: groupval,
            //     CompanyId: companyval,
            //     LoginID: $("#LoginID").val()
            // };

             showButtonLoader($btn, "Saving...");
            showLoader();
            var formData = new FormData();
                formData.append("FirstName", $("#FirstName").val());
                formData.append("MiddleName", $("#MiddleName").val());
                formData.append("LastName", $("#LastName").val());
                formData.append("MobileNo", $("#Mobileno").val());
                formData.append("Email", $("#Email").val());
                formData.append("Password", $("#Password").val());
                formData.append("Address1", $("#Address1").val());
                formData.append("Address2", $("#Address2").val());
                formData.append("Address3", $("#Address3").val());
                formData.append("Pincode", $("#Pincode").val());
                 formData.append("GroupId", $("#grpid").val());
                 formData.append("CompanyId", $("#companyid").val());
                formData.append("LoginID", $("#LoginID").val());


             // 📂 Attach file
                var fileInput = $("#ProfilePhoto")[0];
                 if (fileInput && fileInput.files.length > 0) {
                formData.append("ProfilePhoto", fileInput.files[0]);
               }




             //$btn.prop('disabled', true).text('Saving...');
            $.ajax({
                url: "/api/auth/InsertUserMaster",
                type: "POST",
                //contentType: "application/json",
               data: formData,
               processData: false,
               contentType: false,
               // timeout: 30000,
               // data: JSON.stringify(data),
                success: function (resp, status, xhr) {
                    if (xhr.status === 201) {
                         // $btn.prop('disabled', true).text('Saving...');
                        showMessage("User added successfully!", "success");
                        resetForm();
                        //loadUsers();

                        //  var tabTrigger = document.querySelector('#tab2-tab');
                        // var tab = new bootstrap.Tab(tabTrigger)
                        // tab.show();


                    }
                },
                error: function (xhr) {
                    if (xhr.status === 409) {
                        showMessage("User already exists!", "warning");
                    } else {
                        showMessage("Error saving user.", "danger");
                    }
                },
                 complete: function () {
                    hideButtonLoader($btn, originalText);
                    hideLoader();
                }
            });
        });

        // Edit User
        $(document).on("click", ".btn-edit", function () {
            var id = $(this).closest("td").find(".hiddenUser").val();
            showLoader();
            $.ajax({
                url: "/api/auth/GetByIdUserMaster",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ Id: id }),
                success: function (resp) {
                    if (resp) {
                        var u = resp.data || resp; // handle if wrapped in { data: ... }
                        $("#Id").val(u.id);
                        $("#FirstName").val(u.firstName);
                        $("#MiddleName").val(u.middleName);
                        $("#LastName").val(u.lastName);
                        $("#Mobileno").val(u.mobileNo);
                        $("#Email").val(u.email);
                        $("#Password").val(u.password);
                        $("#Address1").val(u.address1);
                        $("#Address2").val(u.address2);
                        $("#Address3").val(u.address3);
                        $("#Pincode").val(u.pincode);
                        //$("#ProfilePhoto").val(u.profilePhoto);
                     if (u.profilePhotoPath) {
                         var path = "/uploads/" + u.profilePhotoPath;
                         $("#ProfilePath").text(path);                  // show to user
                         $("#ProfilePhotoPath").val(path);              // store for update
                     }if (u.profilePhoto) {
                      $("#ProfilePath").text("/uploads/" + u.profilePhoto);
                     }
                        $("#grpid").val(u.groupId);
                        $("#companyid").val(u.companyId);
                        $("#LoginID").val(u.loginID);

                        // Store ScreenId in hidden field for update
                if ($("#Id").length === 0) {
                    $("#usergrpForm").append('<input type="hidden" id="Id" value="' + id + '">');
                } else {
                    $("#Id").val(id);
                }


                        $("#btnSave").hide();
                        $("#btnUpdate").show();

                        var tab = new bootstrap.Tab(document.querySelector('#tab1-tab'));
                        tab.show();
                    }
                },
                error: function () {
                    showMessage("Failed to fetch user details.", "danger");
                },
                complete: function () {
                    hideLoader();
                }
            });
        });

        // Update User
        $("#btnUpdate").on("click", function (e) {
            e.preventDefault();

            // ✅ Call shared validation before AJAX
             if (!validateEmailAndMobile()) return;
            const $btn = $(this);
            const originalText = $btn.find('span').text();
            //const $btn = $(this);
             const ddlgroup=document.getElementById('grpid');
            const groupval = ddlgroup.value;
             //const txt = ddlgroup.options[ddlgroup.selectedIndex]?.text ?? '';
             const ddlcompany=document.getElementById('companyid');
            const companyval = ddlcompany.value;
            // var data = {
            //     Id: $("#Id").val(),
            //     FirstName: $("#FirstName").val(),
            //     MiddleName: $("#MiddleName").val(),
            //     LastName: $("#LastName").val(),
            //     MobileNo: $("#Mobileno").val(),
            //     Email: $("#Email").val(),
            //     //PasswordHash: $("#Password").val(),
            //     Address1: $("#Address1").val(),
            //     Address2: $("#Address2").val(),
            //     Address3: $("#Address3").val(),
            //     Pincode: $("#Pincode").val(),
            //     ProfilePhoto: $("#ProfilePhoto").val(),
            //     GroupId: groupval,
            //     CompanyId: companyval,
            //     LoginID: $("#LoginID").val()
            // };
            showButtonLoader($btn, "Updating...");
            showLoader();
            var formData = new FormData();
                formData.append("Id", $("#Id").val());
                formData.append("FirstName", $("#FirstName").val());
                formData.append("MiddleName", $("#MiddleName").val());
                formData.append("LastName", $("#LastName").val());
                formData.append("MobileNo", $("#Mobileno").val());
                formData.append("Email", $("#Email").val());
                formData.append("Password", $("#Password").val());
                formData.append("Address1", $("#Address1").val());
                formData.append("Address2", $("#Address2").val());
                formData.append("Address3", $("#Address3").val());
                formData.append("Pincode", $("#Pincode").val());
                formData.append("GroupId", $("#grpid").val());   // must be a number (like "1")
                formData.append("CompanyId", $("#companyid").val());

                // formData.append("GroupId", "groupval");
                // formData.append("CompanyId", "companyval");
                formData.append("LoginID", $("#LoginID").val());

                var fileInput = $("#ProfilePhoto")[0];
                if (fileInput && fileInput.files.length > 0) {
                    formData.append("ProfilePhoto", fileInput.files[0]); // new file
                } else {
                    formData.append("ProfilePhotoPath", $("#ProfilePhotoPath").val() || ""); // old path
                }



              //$btn.prop('disabled', true).text('Updating...');
            $.ajax({
                url: "/api/auth/UpdateUserMaster",
                type: "PUT",
               data: formData,
               processData: false,
               contentType: false,
                //contentType: "application/json",
                //data: JSON.stringify(data),
                success: function (resp, status, xhr) {
                    if (xhr.status === 201) {
                        showMessage("User updated successfully!", "success");
                        resetForm();
                        //loadUsers();
                        //var tab = new bootstrap.Tab(document.querySelector('#tab2-tab'));
                        //tab.show();
                    }
                },
                error: function () {
                    showMessage("Update failed.", "danger");
                },
                complete: function () {
                    hideButtonLoader($btn, originalText);
                    hideLoader();
                }
            });
        });

        // Delete User
        $(document).on("click", ".btn-delete", function () {
            var id = $(this).closest("td").find(".hiddenUser").val();
            if (!confirm("Are you sure you want to delete this user?")) return;

            const $btn = $(this);

            // Store original content and show loading
                const originalContent = $btn.html();
               // $btn.html('<i class="spinner-border spinner-border-sm"></i> Deleting...');
                $btn.prop('disabled', true);

                showLoader();

            $.ajax({
                url: "/api/auth/DeleteUserMaster",
                type: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({ Id: id }),
                success: function () {
                    showMessage("User deleted successfully!", "success");
                    loadUsers();
                },
                error: function () {
                    showMessage("Delete failed.", "danger");
                },
                complete: function () {
                    //hideButtonLoader($btn, originalText);
                    hideLoader();
                }
            });
        });

        // Load users when Tab2 is shown
        $('#tab2-tab').on('shown.bs.tab', function () {
            loadUsers();
        });

         // Initial reset
        resetForm();
    });



</script>
